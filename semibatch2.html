<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Semi-batch</title>

  <script src="https://unpkg.com/mathjs@7.0.1/dist/math.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>

  <style>
form  { display: table;      }
label { display: table-cell; }
input { display: table-cell; }
.p_form{ display: table-row;  }

.imagesize{
height: auto;
width: 60%;
text-align: center;
}

    body {
      font-family: sans-serif;
    }

  .item1{background:whitesmoke;}
  .item2{background:whitesmoke;}
  .item3{background:whitesmoke;}
  .container {
    font-size: 12px;
    background: white;
    padding: 20px;
    display: grid;
    grid-template-columns: repeat(2, minmax(0px, 1fr));
    grid-template-rows: 0.8fr;
    grid-gap: 20px;
  }

  </style>

</head>
<body>
  <h1>Isothermal semi-batch reactor</h1>
  <p>
    This example simulates the concentration profiles inside a semi-batch reactor for the irreversible reaction A + B -> C under isothermal conditions using a system of ordinary differential equations.
  </p>

    <!--Form for submitting parameters-->
<div class="container"> <!-- upper section of container 3 start-->

  <div> <!-- Row 1 column 1 start-->

    <form action="/action_page.php">
      <p class="p_form">
        <label for="timestep_size">Time step size [s]:</label>
        <input type="text" id="timestep_size" name="timestep_size" value="1"><br>
    </p>
    <p class="p_form">
        <label for="initial_volume">Initial volume [L]:</label>
        <input type="text" id="initial_volume" name="initial_volume" value="6000"><br>
  </p>
  <p class="p_form">
        <label for="feed_rate">Feed rate [L/s]:</label>
        <input type="text" id="feed_rate" name="feed_rate" value="10"><br>
      </p>
      <p class="p_form">
        <label for="feed_concentration">Feed concentration [mol/L]:</label>
        <input type="text" id="feed_concentration" name="feed_concentration" value="0.1"><br>
      </p>
      <p class="p_form">
        <label for="feed_concentration">Simulation time [s]:</label>
        <input type="text" id="simulation_time" name="simulation_time" value="1600"><br>
      </p>
      <p class="p_form">
        <label for="conc_a0">cA0 [mol/L]:</label>
        <input type="text" id="conc_a0" name="conc_a0" value="0"><br>
      </p>
      <p class="p_form">
        <label for="conc_b0">cB0 [mol/L]:</label>
        <input type="text" id="conc_b0" name="conc_b0" value="0.1"><br>
      </p>
      <p class="p_form">
        <label for="conc_c0">cC0 [mol/L]:</label>
        <input type="text" id="conc_c0" name="conc_c0" value="0"><br>
      </p>
      <p class="p_form">
        <label for="rate_constant">Rate constant k [L/mol/s]:</label>
        <input type="text" id="rate_constant" name="rate_constant" value="0.1"><br>
    </p>
    <p class="p_form">
      <label for="activation_energy">Activation energy Ea [J/mol]:</label>
      <input type="text" id="activation_energy" name="activation_energy" value="10000"><br>
  </p>
  <p class="p_form">
    <label for="reaction_enthalpy">Reaction enthalpy [J/mol]:</label>
    <input type="text" id="reaction_enthalpy" name="reaction_enthalpy" value="10000"><br>
</p>
    <p class="p_form">
      <label for="initial_temperature">Initial temperature [deg C]:</label>
      <input type="text" id="initial_temperature" name="initial_temperature" value="25"><br>
  </p>
    <p class="p_form">
      <label for="feed_temperature">Feed temperature [deg C]:</label>
      <input type="text" id="feed_temperature" name="feed_temperature" value="25"><br><br><br>
  </p>
    </form> 

    <p>
        <button type="button" onclick="myFunction()">Run simulation</button>        <!-- Button for starting the calcs-->
        
        </p>

    </div> <!-- Row 1 column 1 end-->

    <div> <!-- Row 1 column 2 start-->

      <img src="Isothermal_semibatch.png" alt="Picture of semi-batch reactor with feed" class="imagesize">

</div>    <!-- Row 1 column 2 end--> 

  <div class="item1" style="position:relative; height:1fr; width:1fr">  <!-- Row 2 column 1 end--> 
       <canvas id="canvas1"></canvas>
  </div> <!-- Row 2 column 1 end--> 
  <div class="item2" style="position:relative; height:1fr; width:1fr">  <!-- Row 2 column 2 start--> 
       <canvas id="canvas2"></canvas>
  </div> <!-- Row 2 column 2 end--> 
  <div class="item3" style="position:relative; height:1fr; width:1fr">  <!-- Row 3 column 1 start--> 
    <canvas id="canvas3"></canvas>
</div> <!-- Row 3 column 1 end--> 
<div class="item1" style="position:relative; height:1fr; width:1fr">  <!-- Row 3 column 2 start--> 
  <canvas id="canvas4"></canvas>
</div> <!-- Row 3 column 2 end--> 


</div>  <!-- Container end--> 

  <script>

          // Import the numerical ODE solver
    math.import({odesolve:odesolve})

 function odesystem2(x,par){

F = par[0]
 caF = par[1]
 Tf = par[2]
 Q = par[3]

 k = par[4]
 rho = par[5]
 cp = par[6]
 dHr = par[7]
 Ea = par[8]

 t = x[0]
 na = x[1]
 nb = x[2]
 nc = x[3]
 V = x[4]
 T = x[5]
 eint = x[6]
var kr = k*math.exp(-Ea/8.3145/T)
 dtdt = 1
 dnadt = F * caF - k * na * nb / V
 dnbdt = -k * na * nb / V
 dncdt = k * na * nb / V
 dVdt = F
 dTdt = (F*rho*cp*(Tf-T)+k*na*nb*dHr/V+Q)/(V*rho*cp)
 //dTdt = 0
 deintdt = T-Tf
 console.log(dTdt)
 //deintdt = 0
 return [dtdt, dnadt, dnbdt, dncdt, dVdt, dTdt, deintdt]
}


    function odesolve(f,x0,tmax,dt,par){
    //    f: vector of functions returning time derivates
    //   x0: initial conditions
    // tmax: end time of integration
    //   dt: size of time steps
    //    n: number of variables
      var x = x0   // Current values of variables
      num = x.length

    
      var dxdt = []        // Temporary variable to hold time-derivatives
      const nsteps = math.divide(tmax, dt)   // Number of time steps
      result = math.zeros(nsteps+1, 2)      // Contains entire solution

      for(let j=0; j<num; j++) { //Looping over variables
          result.subset(math.index(0,j),x[j])
          }

      for(let i=1; i<nsteps; i++) { //Looping over time steps

          dxdt = f(x,par)
          for(let j=0; j<num; j++) { //Looping over variables
          x[j] = x[j] + dxdt[j]*dt
          result.subset(math.index(i,j),x[j])
          }
      }
   
      return result
    }









    //var res = odesolve(odesystem, [3,6], 100, 1,[])
// Function for calculating the concentration from molar amounts and volume
// input: three vectors n, V and t of same length
// output: array with x (time) and y (concentration) values for plotting
    function concentration_calc(n,V,t){
var storage = [];
for (var i = 0; i < n.length; i++) {
var temptime = t[i]/1;
var json = {x: temptime, y: n[i] / V[i]};
storage.push(json);
}
return storage
    }
    function myFunction(){
    // Create a math.js context for our simulation. Everything else occurs in the context of the expression parser!
    const sim2 = math.parser()
    const sim = math.parser()
    x_zero = []
    var timestep = document.getElementById("timestep_size").value;
    var teststring2 = "dt = " + timestep
    var initial_volume = document.getElementById("initial_volume").value;
    x_zero[4] = initial_volume/1



    var simulation_time = document.getElementById("simulation_time").value;
    simulation_time = "tfinal = " + simulation_time
    var cA_init = document.getElementById("conc_a0").value;
    var cB_init = document.getElementById("conc_b0").value;
    var cC_init = document.getElementById("conc_c0").value;
    var nA_init = initial_volume * cA_init
    var nB_init = initial_volume * cB_init
    var nC_init = initial_volume * cC_init
    var tsim = document.getElementById("simulation_time").value;
    var tstep = document.getElementById("timestep_size").value;
    var Ea = document.getElementById("activation_energy").value;
    var dHr = document.getElementById("reaction_enthalpy").value;
    var Tinit = document.getElementById("initial_temperature").value;
    var Tfeed = document.getElementById("feed_temperature").value;
var par = []

par[0] = document.getElementById("feed_rate").value;
par[1] = document.getElementById("feed_concentration").value;
par[2] = Tfeed
par[3] = 0 //Heating / cooling [W]
par[4] = document.getElementById("rate_constant").value;
par[5] = 1 //Density [kg/L]
par[6] = 4186 //Heat capacity [J/kg/K]
par[7] = dHr
par[8] = document.getElementById("activation_energy").value;



    x_zero[0] = 0
    x_zero[1] = nA_init
    x_zero[2] = nB_init
    x_zero[3] = nC_init
 
    x_zero[5] = Tinit + 273.15
    x_zero[6] = Tinit - Tfeed

   // var res = odesolve(odesystem2,x_zero, tsim, tstep, [1, 0.1, 298, 0, 1, 1, 4186, 10000])
    var res = odesolve(odesystem2,x_zero, tsim, tstep, par)

resul_size = math.size(res)
resul_length = math.subset(resul_size, math.index(0))-1
resul_width = math.subset(resul_size, math.index(1))-1

//math.subset(resul, math.index(1, 0)) 
data_NA = []
data_NB = []
data_NC = []
data_Temp = []
data_Volume = []

var_NA = []
var_NB = []
var_NC = []
var_vol = []
var_t = []



for (var i = 0; i < resul_length; i++) {  //Looping through time
  //for (var j = 0; j < resul_width; j++) {
var temp1 = {x: math.subset(res, math.index(i,0))/1, y: math.subset(res, math.index(i,1))/1 };
var temp2 = {x: math.subset(res, math.index(i,0))/1, y: math.subset(res, math.index(i,2))/1 };
var temp3 = {x: math.subset(res, math.index(i,0))/1, y: math.subset(res, math.index(i,3))/1 };
var temp4 = {x: math.subset(res, math.index(i,0))/1, y: math.subset(res, math.index(i,4))/1 };
var temp5 = {x: math.subset(res, math.index(i,0))/1, y: math.subset(res, math.index(i,5))/1 };
var temp6 = math.subset(res, math.index(i,1))/1 //NA
var temp7 = math.subset(res, math.index(i,2))/1 //NB
var temp8 = math.subset(res, math.index(i,3))/1 //NC
var temp9 = math.subset(res, math.index(i,4))/1 //Volume
var temp10 = math.subset(res, math.index(i,0))/1 //time
//var json2 = {x: t_values[i]/1, y: T_values[i] / 1 };
//var json3 = {x: t_values[i]/1, y: eint_values[i] / 1 };
data_NA.push(temp1);
data_NB.push(temp2)
data_NC.push(temp3)
data_Volume.push(temp4)
data_Temp.push(temp5)
var_NA.push(temp6)
var_NB.push(temp7)
var_NC.push(temp8)
var_vol.push(temp9)
var_t.push(temp10)
  //}
}

//data_T.push(json2);
//data_eint.push(json3);
//}

const data_concA = concentration_calc(var_NA,var_vol,var_t)
const data_concB = concentration_calc(var_NB,var_vol,var_t)
const data_concC = concentration_calc(var_NC,var_vol,var_t)


   
// Plotting molar amounts
    window['chart'] = new Chart(document.getElementById('canvas1'), {
      responsive: 'true',
      type: 'line',
      data: {
        datasets: [{
          label: "c_A",
          data: data_NA,
          fill: false,
          borderColor: "red",
          pointRadius: 0
        }, {
          label: "n_B",
          data: data_NB,
          fill: false,
          borderColor: "green",
          pointRadius: 0
        }, {
          label: "n_C",
          data: data_NC,
          fill: false,
          borderColor: "orange",
          pointRadius: 0
        }]
      },
      options: {
        title: {
            display: true,
            text: 'Molar amounts'
               },
        scales: {
          xAxes: [{
            type: 'linear',
            position: 'bottom',
            scaleLabel: {
                          display: true,
                          labelString: 'Time [s]'
                        }
            
          }],
          yAxes: [{
            type: 'linear',
            scaleLabel: {
                          display: true,
                          labelString: 'Molar amount [mol]'
                        }
            
          }]
        }
      }

    })

    //Plotting concentration profiles
    window['chart'] = new Chart(document.getElementById('canvas2'), {
      responsive: 'true',
      type: 'line',
      data: {
        datasets: [{
          label: "c_A",
          data: data_concA,
          fill: false,
          borderColor: "red",
          pointRadius: 0
        }, {
          label: "c_B",
          data: data_concB,
          fill: false,
          borderColor: "green",
          pointRadius: 0
        }, {
          label: "c_C",
          data: data_concC,
          fill: false,
          borderColor: "orange",
          pointRadius: 0
        }]
      },
      options: {
        title: {
            display: true,
            text: 'Concentration profiles'
               },
        scales: {
          xAxes: [{
            type: 'linear',
            position: 'bottom',
            scaleLabel: {
                          display: true,
                          labelString: 'Time [s]'
                        }
            
          }],
          yAxes: [{
            type: 'linear',
            scaleLabel: {
                          display: true,
                          labelString: 'Concentration [mol/L]'
                        }
            
          }]
        }
      }

    })

    //Plotting volume as a function of time
    window['chart'] = new Chart(document.getElementById('canvas3'), {
      responsive: 'true',
      type: 'line',
      data: {
        datasets: [{
          label: "V",
          data: data_Volume,
          fill: false,
          borderColor: "black",
          pointRadius: 0
        }]
      },
      options: {
        title: {
            display: true,
            text: 'Filling volume'
               },
        scales: {
          xAxes: [{
            type: 'linear',
            position: 'bottom',
            scaleLabel: {
                          display: true,
                          labelString: 'Time [s]'
                        }
            
          }],
          yAxes: [{
            type: 'linear',
            scaleLabel: {
                          display: true,
                          labelString: 'Volume [L]'
                        }
            
          }]
        }
      }

    })

    window['chart'] = new Chart(document.getElementById('canvas4'), {
      responsive: 'true',
      type: 'line',
      data: {
        datasets: [{
          label: "V",
          data: data_NA,
          fill: false,
          borderColor: "black",
          pointRadius: 0
        },{
          label: "V",
          data: data_NB,
          fill: false,
          borderColor: "black",
          pointRadius: 0
        },{
          label: "V",
          data: data_NC,
          fill: false,
          borderColor: "black",
          pointRadius: 0
        }]
      },
      options: {
        title: {
            display: true,
            text: 'Filling volume'
               },
        scales: {
          xAxes: [{
            type: 'linear',
            position: 'bottom',
            scaleLabel: {
                          display: true,
                          labelString: 'Time [s]'
                        }
            
          }],
          yAxes: [{
            type: 'linear',
            scaleLabel: {
                          display: true,
                          labelString: 'Temperature [K]'
                        }
            
          }]
        }
      }

    })
    

}
  </script>

</body>
</html>